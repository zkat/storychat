"use strict";

let fs = require("fs"),
    env = process.env.NODE_ENV || "development",
    extend = require("lodash").extend;

function readConfig(name) {
  return JSON.parse(
    fs.readFileSync(
      __dirname + "/../../../config/"+name+".json"));
}

let dbConfig = readConfig("db")[env];

/*jshint camelcase:false*/
if (dbConfig.use_env_variable) {
  let dbInfo = process.env[dbConfig.use_env_variable].match(
      /([^:]+):\/\/([^:]+):([^@]+)@([^:]+):(\d+)\/(.+)/);
  dbConfig.database = dbInfo[6];
  dbConfig.username = dbInfo[2];
  dbConfig.password = dbInfo[3];
  dbConfig.host = dbInfo[4];
  dbConfig.port = dbInfo[5];
  dbConfig.dialect = dbInfo[1];
  dbConfig.protocol = dbInfo[1];
}
/*jshint camelcase:true*/

dbConfig = extend({}, {
  maxConcurrentQueries: 100,
  logging: dbConfig.logging !== undefined ?
    dbConfig.logging :
    (env === "development" ?
     console.info : false),
  pool: { maxConnections: 50, maxIdleTime: 30 }
}, dbConfig);

module.exports = {
  env: env,
  app: readConfig("app")[env],
  db: dbConfig
};
