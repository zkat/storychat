"use strict";

let Sequelize = require("sequelize"),
    fs = require("fs"),
    env = process.env.NODE_ENV || "development",
    extend = require("lodash").extend,
    Q = require("q"),
    config = JSON.parse(
      fs.readFileSync(__dirname + "/../../../../config/db.json"))[env];

/*jshint camelcase:false*/
if (config.use_env_variable) {
  let dbInfo = process.env[config.use_env_variable].match(
      /([^:]+):\/\/([^:]+):([^@]+)@([^:]+):(\d+)\/(.+)/);
  config.database = dbInfo[6];
  config.username = dbInfo[2];
  config.password = dbInfo[3];
  config.host = dbInfo[4];
  config.port = dbInfo[5];
  config.dialect = dbInfo[1];
  config.protocol = dbInfo[1];
}
/*jshint camelcase:true*/

config = extend({}, {
  maxConcurrentQueries: 100,
  logging: typeof config.logging !== "undefined" ? config.logging :
    (env === "development" ?
     console.info : false),
  pool: { maxConnections: 50, maxIdleTime: 30 }
}, config);

function connect() {
  return new Sequelize(config.database, config.username,
                       config.password, config);
}

let db = connect();
function query(q, args) {
  let deferred = Q.defer();
  db.query(q, {}, {raw: true}, args).success(function(results) {
    deferred.resolve(results);
  }).error(function(err) {
    console.error("Error while processing query '", q, "', ", err);
    deferred.reject(err, true);
  });
  return deferred.promise;
}

module.exports = {
  query: query
};
